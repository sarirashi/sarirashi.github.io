<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<h2>Hello OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>
<p><button id="getImgBtn">获取图像</button></p>
<div>
  <div class="inputoutput">
    <div>
        <canvas id="canvasInput" width="1440" height="640"></canvas>
    </div>
    <div class="caption">输入图片 <input type="file" id="fileInput" accept="image/*" name="file" /></div>
  </div>
</div>
<div>
  <div class="inputoutput">
    <div>
        <canvas id="canvasOutput"></canvas>
    </div>
    <div class="caption">输出图片</div>
  </div>
</div>
<script type="text/javascript">
let inputElement = document.getElementById('fileInput');
let imgBtn = document.getElementById('getImgBtn');
let img = new Image();
let loading = true;
inputElement.addEventListener('change', (e) => {
    img.src = URL.createObjectURL(e.target.files[0]);
}, false);
img.onload = function() {
    let inCanvas = document.getElementById('canvasInput')
    let inCanvasCtx = inCanvas.getContext('2d')
    inCanvasCtx.drawImage(img,0,0,img.width,img.height,0,0,1440,640);
    if(img.width!==1440 ||  img.height!=640) {
        inCanvas.toBlob(function(blob) {
            console.log()
            img.src = URL.createObjectURL(blob);
        })
    }
};
imgBtn.addEventListener('click', (e) => {
    if(loading) {
        return alert('正在加载opencv.js和模型文件')
    }
    if(!img.src) {
        return alert('请先上传图片')
    }
    let src = cv.imread('canvasInput');
    let gray = new cv.Mat();
    let gray2 = new cv.Mat();
    let gray3 = new cv.Mat();
    let ksize = new cv.Size(3,3);
    cv.cvtColor(src, gray, cv.COLOR_BGR2GRAY);
    cv.threshold (gray, gray2, 120, 255, cv.THRESH_BINARY);
    cv.imshow('canvasOutput',gray2);
    src.delete();gray.delete();gray2.delete();
});
function onOpenUtilsReady() {
    let utils = new Utils('errorMessage');
    utils.loadOpenCv(() => {
    let cvFile = 'opencv.js';
    utils.createFileFromUrl(cvFile, cvFile, () => {
        document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
        loading = false;
    });
});
}

</script>
<script async src="./utils.js" onload="onOpenUtilsReady();" type="text/javascript"></script>
<!-- <script async src="./opencv.js" onload="onOpenCvReady();" type="text/javascript"></script> -->
<style>
.inputoutput{
    display: inline-block;
}
</style>
</body>
</html>